# メール分類・連携機能 基本設計書

## 1. 概要
本機能は、Gmailと連携し、就活に関連するメールを自動で取り込み、企業ごとに分類・可視化する機能である。
また、メール内容からイベント（面接日程など）やES（エントリーシート）の締切を自動抽出し、カレンダーやタスク管理と連携する。

## 2. アーキテクチャ概要

### 2.1 システム構成
- **Frontend (Renderer Process)**:
  - React + Material-UIを用いたメール一覧・詳細表示
  - 添付ファイルプレビュー
  - 手動連携・設定画面
- **Backend (Main Process)**:
  - **Gmail Service**: Gmail APIとの通信、認証管理
  - **Sync Service**: 定期的なメール同期、Pub/Sub通知の受信（Pull型）
  - **Parser Service**: メール本文の解析、日付・重要情報の抽出
  - **Database**: SQLiteへのデータ永続化

### 2.2 データフロー
1. **受信**: Gmail API (Pub/Sub or Polling) を介して新着メールを検知。
2. **保存**: メールヘッダー、本文、添付ファイル情報を `email_messages` テーブルに保存。
3. **分類**: 送信元アドレスやドメイン、本文キーワードを基に `companies` テーブルと紐付け。
4. **解析**: 本文を解析し、日時情報や「締切」「面接」などのキーワードを抽出。
5. **連携**: 抽出情報に基づき `events` (カレンダー) や `es_entries` (ES管理) のドラフトを作成。

## 3. 機能要件

### 3.1 Gmail連携・同期
- **認証**: OAuth2.0を用いたセキュアな認証（既存実装あり）。
- **リアルタイム同期**:
  - Google Cloud Pub/Subを利用したPush通知（またはPull）により、新着メールを即座に検知。
  - バックアップとして定期ポーリングも併用。

### 3.2 メール表示・添付ファイル
- **企業別表示**: 企業詳細ページに「メール」タブを追加し、その企業に関連するメールのみを表示。
- **添付ファイル**:
  - メール詳細画面で添付ファイル一覧を表示。
  - クリックでダウンロード・プレビュー（PDF, 画像）。

### 3.3 自動作成・連携
- **イベント作成**:
  - 「面接」「説明会」などのキーワードと日時表現（例: "12月1日 10:00"）を検出し、カレンダーイベント候補を作成。
- **ES作成**:
  - 「ES締切」「提出期限」などのキーワードを検出し、ES管理のエントリ候補を作成。

### 3.4 自動分類 (AI/ルールベース)
- **ルールベース**:
  - ドメイン一致（例: `@google.com` -> Google）
  - 件名・本文キーワード（例: "株式会社〇〇"）
- **AI (Optional)**:
  - Gemini API等を用いて、メールの重要度判定や要約を行う（今回は優先度低、拡張性を持たせる）。

## 4. データベース設計 (既存スキーマ活用)
- `email_accounts`: アカウント管理
- `email_messages`: メール本体
- `company_email_patterns`: 分類ルール
- `companies`: 企業マスタ
- `events`: イベント
- `es_entries`: ES

## 5. UI/UX イメージ
- **企業詳細ページ**:
  - [概要] [ES] [面接] [イベント] **[メール]** ← 新規タブ
- **メールタブ**:
  - スレッド形式のリスト表示
  - 未読/既読管理
  - 「イベントに追加」「ESに追加」のアクションボタン

## 6. 技術的制約・前提
- Google Cloud Projectの設定が必要（Pub/Sub API有効化）。
- デスクトップアプリのため、Pub/Subは **Pull Subscription** を使用する（Webhookを受け取るサーバーがないため）。
